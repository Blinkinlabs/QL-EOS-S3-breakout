
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.1.5">
    
    
      
        <title>Advanced Topics - QL_EOS_S3 breakout</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.21aed14c.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.196e0c26.min.css">
        
      
    
    
    
      
        
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
      
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#advanced-topics" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="QL_EOS_S3 breakout" class="md-header-nav__button md-logo" aria-label="QL_EOS_S3 breakout">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            QL_EOS_S3 breakout
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Advanced Topics
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="QL_EOS_S3 breakout" class="md-nav__button md-logo" aria-label="QL_EOS_S3 breakout">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    QL_EOS_S3 breakout
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../getting_started/" class="md-nav__link">
      Getting Started
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../toolchain/" class="md-nav__link">
      Toolchain Setup
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../pinout/" class="md-nav__link">
      Pinout and Peripherals
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Advanced Topics
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="./" class="md-nav__link md-nav__link--active">
      Advanced Topics
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#reprogramming-the-spi-flash" class="md-nav__link">
    Reprogramming the SPI flash
  </a>
  
    <nav class="md-nav" aria-label="Reprogramming the SPI flash">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-1-build-the-bootloader" class="md-nav__link">
    Step 1: Build the bootloader
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-make-a-flash-image" class="md-nav__link">
    Step 2: Make a flash image
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-3-flash-it" class="md-nav__link">
    Step 3: Flash it
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#set-the-io-pins-in-bank-a-to-a-different-reference-voltage" class="md-nav__link">
    Set the IO pins in Bank A to a different reference voltage
  </a>
  
    <nav class="md-nav" aria-label="Set the IO pins in Bank A to a different reference voltage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#introduction_1" class="md-nav__link">
    Introduction
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-1-cut-the-vccioa-trace-on-the-back-of-the-board" class="md-nav__link">
    Step 1: Cut the VCCIOA trace on the back of the board
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-provide-a-171-36v-reference-on-the-vcca-pin" class="md-nav__link">
    Step 2: Provide a 1.71 - 3.6V reference on the VCCA pin
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#attach-a-jtag-debugger" class="md-nav__link">
    Attach a JTAG debugger
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#reprogramming-the-spi-flash" class="md-nav__link">
    Reprogramming the SPI flash
  </a>
  
    <nav class="md-nav" aria-label="Reprogramming the SPI flash">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-1-build-the-bootloader" class="md-nav__link">
    Step 1: Build the bootloader
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-make-a-flash-image" class="md-nav__link">
    Step 2: Make a flash image
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-3-flash-it" class="md-nav__link">
    Step 3: Flash it
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#set-the-io-pins-in-bank-a-to-a-different-reference-voltage" class="md-nav__link">
    Set the IO pins in Bank A to a different reference voltage
  </a>
  
    <nav class="md-nav" aria-label="Set the IO pins in Bank A to a different reference voltage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#introduction_1" class="md-nav__link">
    Introduction
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-1-cut-the-vccioa-trace-on-the-back-of-the-board" class="md-nav__link">
    Step 1: Cut the VCCIOA trace on the back of the board
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-provide-a-171-36v-reference-on-the-vcca-pin" class="md-nav__link">
    Step 2: Provide a 1.71 - 3.6V reference on the VCCA pin
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#attach-a-jtag-debugger" class="md-nav__link">
    Attach a JTAG debugger
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="advanced-topics">Advanced topics</h1>
<h2 id="reprogramming-the-spi-flash">Reprogramming the SPI flash</h2>
<h3 id="introduction">Introduction</h3>
<p>The EOS-S3 SoC does not have internal nonvolatile memory, so it boots from an external SPI flash. The breakout board has a bootloader pre-installed in the flash memory, which can be used to program the device using it's USB port. However, if the bootloader becomes corrupted for whatever reason, it can be useful to restore the whole SPI flash.</p>
<p>To do this, you'll need a <a href="https://www.pjrc.com/store/teensy32.html">Teensy</a> with the <a href="https://github.com/osresearch/spiflash">spiflash</a> firmware loaded.</p>
<p>First, some technical details. This is the flash memory layout that the quickfeather bootloader is expecting:</p>
<table>
<thead>
<tr>
<th>Item</th>
<th>Status</th>
<th align="right">Start</th>
<th align="right">Size</th>
<th align="right">End</th>
<th align="right">Start</th>
<th align="right">Size</th>
<th align="right">End</th>
</tr>
</thead>
<tbody>
<tr>
<td>bootloader</td>
<td>Used</td>
<td align="right">0x0000_0000</td>
<td align="right">0x0001_0000</td>
<td align="right">0x0000_FFFF</td>
<td align="right">0</td>
<td align="right">65,536</td>
<td align="right">65,536</td>
</tr>
<tr>
<td>bootfpga CRC</td>
<td>Used</td>
<td align="right">0x0001_0000</td>
<td align="right">8</td>
<td align="right">0x0001_0007</td>
<td align="right">65,536</td>
<td align="right">8</td>
<td align="right">65,544</td>
</tr>
<tr>
<td>appfpga CRC</td>
<td>Future</td>
<td align="right">0x0001_1000</td>
<td align="right">8</td>
<td align="right">0x0001_1007</td>
<td align="right">69,632</td>
<td align="right">8</td>
<td align="right">69,640</td>
</tr>
<tr>
<td>appffe CRC</td>
<td>Future</td>
<td align="right">0x0001_2000</td>
<td align="right">8</td>
<td align="right">0x0001_2007</td>
<td align="right">73,728</td>
<td align="right">8</td>
<td align="right">73,736</td>
</tr>
<tr>
<td>M4app CRC</td>
<td>Used</td>
<td align="right">0x0001_3000</td>
<td align="right">8</td>
<td align="right">0x0001_3007</td>
<td align="right">77,824</td>
<td align="right">8</td>
<td align="right">77,832</td>
</tr>
<tr>
<td>bootloader CRC</td>
<td>Used</td>
<td align="right">0x0001_4000</td>
<td align="right">8</td>
<td align="right">0x0001_4007</td>
<td align="right">81,920</td>
<td align="right">8</td>
<td align="right">81,928</td>
</tr>
<tr>
<td>bootfpga</td>
<td>Used</td>
<td align="right">0x0002_0000</td>
<td align="right">0x0002_0000</td>
<td align="right">0x0003_FFFF</td>
<td align="right">131,072</td>
<td align="right">131,072</td>
<td align="right">262,144</td>
</tr>
<tr>
<td>appfpga</td>
<td>Future</td>
<td align="right">0x0004_0000</td>
<td align="right">0x0002_0000</td>
<td align="right">0x0005_FFFF</td>
<td align="right">262,144</td>
<td align="right">131,072</td>
<td align="right">393,216</td>
</tr>
<tr>
<td>appffe</td>
<td>Future</td>
<td align="right">0x0006_0000</td>
<td align="right">0x0002_0000</td>
<td align="right">0x0007_FFFF</td>
<td align="right">393,216</td>
<td align="right">131,072</td>
<td align="right">524,288</td>
</tr>
<tr>
<td>M4app</td>
<td>Used</td>
<td align="right">0x0008_0000</td>
<td align="right">0x0006_E000</td>
<td align="right">0x000E_DFFF</td>
<td align="right">524,288</td>
<td align="right">450,560</td>
<td align="right">974,848</td>
</tr>
</tbody>
</table>
<p>The hardware in the SoC only cares about the first section, which contains the bootloader. When it comes out of reset, configuration logic in the SoC reads 32 bits of data from the SPI flash location 0x120, which contains a device ID, the size of the bootloader image, and the desired SPI clock setting. If these are valid, the configuration logic then copies the bootloader into the device SRAM, and then starts the ARM processor.</p>
<p>Once it starts, the bootloader displays a prompt on the UART pins, then waits 5 seconds. If the user button is pressed during these 5 seconds, then it loads the bootfpga image into the FPGA, which allows the user to reprogram the device using the TinyFPGA programmer. If the button is not pressed within 5 seconds, the bootloader attempts to load the user program from the SPI flash into SRAM. It then verifies that the CRC makes (TODO: Does it actually do this?), and if it does, reconfigures the ARM to point to that code, to enter the user program.</p>
<p>The TLDR here is that if we want to write a raw image to the flash, we'll need at least the bootloader, bootloader CRC, bootfpga, andd bootfpga CRC sections to be present. For extra points, we can also preinstall a user app by filling the M4app and M4app CRC sections.</p>
<h3 id="step-1-build-the-bootloader">Step 1: Build the bootloader</h3>
<p>First, let's build the bootloader:</p>
<pre><code>cd ~/ql-eos-s3/qorc-sdk/bl_apps/bl_bootloader/GCC_Project
make
</code></pre>
<p><em>TODO: what sets up the 0x120 offset in the bootloader binary?</em></p>
<h3 id="step-2-make-a-flash-image">Step 2: Make a flash image</h3>
<p>A tool to build a suitable image is included in the <a href="https://github.com/Blinkinlabs/bl_apps/blob/main/tools/build_flash_image.py">bl apps</a>. Using it with the default options will grab the bootloader binary image that we just compiled above, as well as a (for now) precompiled appfpga image:</p>
<pre><code>cd ~/ql-eos-s3/qorc-sdk/bl_apps/tools
python3 build_flash_image.py
added section:bootloader at:0x00000000 size:38228 crc:0x555d0a3e
added section:bootfpga at:0x00020000 size:75960 crc:0x82fc1983
Wrote 0xee000 bytes to image.bin
</code></pre>
<p>This should create a file called 'image.bin', which we can then load on the SPI flash chip, starting at offset 0.</p>
<h3 id="step-3-flash-it">Step 3: Flash it</h3>
<p>Connect the Teensy to the dev board like so. Be sure to short the 'RST' pin on the board to 'GND', to prevent the SoC from booting:</p>
<p><img alt="Teensy flash diagram" src="../img/teensy_spi_flash_connection_revb.png" /></p>
<p><em>TODO: text version of the pin table</em></p>
<p>Next, connect both the Teensy and the board to your computer using USB. Use your favorite serial terminal to connect to the Teensy. Issue the 'i' command to check if the SPI flash can be identified:</p>
<pre><code>i
C84015C8
</code></pre>
<p><em>Note: The device ID for the flash on your board may differ, this is for the 2MB version</em></p>
<p>Now, tell the Teensy that we want to write EE000 bytes to the SPI flash, starting at offset 0. If the flash image was a different length, use that instead:</p>
<pre><code>u0 EE0000
G 00000000 EE0000
</code></pre>
<p><em>Note: The 'u' will not be echoed to the terminal</em></p>
<p>Exit the serial terminal, and then use the PV command to write the image:</p>
<pre><code>pv image.bin &gt; /dev/ttyACM0
</code></pre>
<p>Now, detach the Teensy, then remove the jumper between RST and GND to boot flash image.</p>
<h2 id="set-the-io-pins-in-bank-a-to-a-different-reference-voltage">Set the IO pins in Bank A to a different reference voltage</h2>
<h3 id="introduction_1">Introduction</h3>
<p>If you need to interface with a device that uses a different logic voltage than 3.3V, it is possible to set the reference voltage for the pins on Bank A.</p>
<h3 id="step-1-cut-the-vccioa-trace-on-the-back-of-the-board">Step 1: Cut the VCCIOA trace on the back of the board</h3>
<p>On the back side of the board, cut the short copper trace in the middle of the 'VCCIOA' pad. This will disconnect the VCCIOA power line from the on-board 3.3V regulator:
<img alt="Cut the VCCIO trace" src="../img/vccioa_cut_trace_revb.png" /></p>
<h3 id="step-2-provide-a-171-36v-reference-on-the-vcca-pin">Step 2: Provide a 1.71 - 3.6V reference on the VCCA pin</h3>
<p>Once the trace has been cut, you'll need to connect an external voltage to the header pin marked 'VCCA'. Then, all of the pins on the right-hand side of the board will be referenced to the external supply:
<img alt="VCCIOA pins" src="../img/vccioa_pins_revb.png" /></p>
<p><em>Note: The datasheet specifies a range of 1.71-3.6V for safe operation</em></p>
<h2 id="attach-a-jtag-debugger">Attach a JTAG debugger</h2>
<p><em>TODO</em></p>
<p>Using JTAG with the RevB board reuqires pulling up both IO_8 and IO_9, and supplying a clock to FCLK. Additionally, the 10k pullups on SWD and SCK may not be present, and would need to be added externally. A future revision will use an alternate JTAG pin mapping, to allow it to be used with the on-board oscillator.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../pinout/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Pinout and Peripherals
              </div>
            </div>
          </a>
        
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.7e0ee788.min.js"></script>
      <script src="../assets/javascripts/bundle.b3a72adc.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.4ac00218.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>